pkgname=glibc
pkgver=2.34
pkgrel=1
pkgdesc="GNU C Library"
arch=('x86_64')
url="http://www.gnu.org/software/libc"
license=(GPL LGPL)
options=(!strip staticlibs)
source=(https://ftp.gnu.org/gnu/glibc/glibc-$pkgver.tar.xz
	glibc-2.34-fhs-1.patch
        glibc.install)
	
md5sums=('31998b53fb39cb946e96abc310af1c89'
	 'SKIP'
	 'SKIP')

install=glibc.install

prepare() {
cd /usr/src/glibc/2.34/src/glibc-2.34
sed -e '/NOTIFY_REMOVED)/s/)/ \&\& data.attr != NULL)/' \
    -i sysdeps/unix/sysv/linux/mq_notify.c
patch -Np1 -i /usr/src/glibc/2.34/glibc-2.34-fhs-1.patch
}

build() {
cd "${srcdir}/${pkgname}-${pkgver}"
mkdir glibc-build
cd glibc-build

export CPPFLAGS=${CPPFLAGS/-D_FORTIFY_SOURCE=2/}
export CFLAGS=${CFLAGS/-fno-plt/}

CC="gcc -ffile-prefix-map=/tools=/usr" \
../configure --prefix=/                           \
             --disable-werror                     \
             --enable-kernel=3.2                  \
             --enable-stack-protector=strong      \
             --with-headers=/include              \
             libc_cv_slibdir=/lib

  echo "slibdir=/lib" >> configparms
  echo "rtlddir=/lib" >> configparms
  echo "sbindir=/bin" >> configparms
  echo "rootsbindir=/bin" >> configparms

  # remove fortify for building libraries
  CXXFLAGS=${CXXFLAGS/-fno-plt/}
  LDFLAGS=${LDFLAGS/,-z,now/}

make
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}/glibc-build"
  make DESTDIR=${pkgdir} install
}
