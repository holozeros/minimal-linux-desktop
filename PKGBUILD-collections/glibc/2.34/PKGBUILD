pkgname=glibc
pkgver=2.34
pkgrel=1
pkgdesc="GNU C Library"
arch=('x86_64')
url="http://www.gnu.org/software/libc"
license=(GPL LGPL)
options=(!strip staticlibs)
source=(https://ftp.gnu.org/gnu/glibc/glibc-$pkgver.tar.xz
	glibc-2.34-fhs-1.patch
        glibc.install)
	
md5sums=('31998b53fb39cb946e96abc310af1c89'
	 'SKIP'
	 'SKIP')

install=glibc.install

prepare() {
mkdir -p build
[[ -d glibc-$pkgver ]] && ln -s glibc-$pkgver glibc 
cd glibc
sed -e '/NOTIFY_REMOVED)/s/)/ \&\& data.attr != NULL)/' \
    -i sysdeps/unix/sysv/linux/mq_notify.c
patch -Np1 -i ${srcdir}/glibc-2.34-fhs-1.patch
cp ${srcdir}/{sdt.h,sdt-config.h} include/sys/
}

build() {
unset CPPFLAGS
unset CFLAGS
  local _configure_flags=(
      --prefix=/
      --with-headers=/include
      --enable-kernel=4.4
      --enable-stack-protector=strong
      --enable-stackguard-randomization
      --disable-profile
      --disable-werror
      libc_cv_slibdir=/lib
  )

  cd "$srcdir/build"
  echo "slibdir=/lib" >> configparms
  echo "rtlddir=/lib" >> configparms
  echo "sbindir=/bin" >> configparms
  echo "rootsbindir=/sbin" >> configparms
  CPPFLAGS=${CPPFLAGS/-D_FORTIFY_SOURCE=2/}
  CFLAGS=${CFLAGS/-fno-plt/}
  CXXFLAGS=${CXXFLAGS/-fno-plt/}
  LDFLAGS=${LDFLAGS/,-z,now/}

  "$srcdir/glibc/configure" \
      --libdir=/lib \
      --libexecdir=/lib \
      ${_configure_flags[@]}
  echo "build-programs=no" >> configparms
  make

  sed -i "/build-programs=/s#no#yes#" configparms
  echo "CC += -D_FORTIFY_SOURCE=2" >> configparms
  echo "CXX += -D_FORTIFY_SOURCE=2" >> configparms
  make
}

package() {
  cd "${srcdir}/build"
  make DESTDIR=${pkgdir} install
}
